<!-- Generated by SpecStory -->

# Test failure in batch retrieval (2025-06-08 18:43:13)

_**User**_

    C:\dev\ktsu-dev\BlastMerge\BlastMerge.Test\AppDataBatchManagerTests.cs(171): error test failed:
      GetAllBatches_MultipleBatches_ReturnsAllBatches (12ms): Assert.AreEqual failed. Expected:<2>. Actual:<4>.
      Stack Trace:
         at ktsu.BlastMerge.Test.AppDataBatchManagerTests.GetAllBatches_MultipleBatches_ReturnsAllBatches() in C
      :\dev\ktsu-dev\BlastMerge\BlastMerge.Test\AppDataBatchManagerTests.cs:line 171
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isCo
      nstructor)
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)

---

_**Assistant**_



---

I see there's a failing test in the `AppDataBatchManagerTests.cs` file. The test is expecting 2 batches but getting 4. Let me examine the test to understand what's happening.

---

Read file: BlastMerge.Test/AppDataBatchManagerTests.cs

---

Now let me look at the test setup and cleanup methods to understand how the test environment is managed:

---

Read file: BlastMerge.Test/AppDataBatchManagerTests.cs

---

Now let me examine the `AppDataBatchManager` implementation to understand why it might be returning 4 batches instead of 2:

---

<details>
            <summary>Searched codebase "AppDataBatchManager" • **2** results</summary>
        
| File |
|------|
| `undefined` |
| `undefined` |

</details>

---

Read file: BlastMerge.Core/Services/AppDataBatchManager.cs

---

Now let me examine the `BlastMergeAppData` class to see if there's an issue with how it manages the data:

---

<details>
            <summary>Searched codebase "BlastMergeAppData" • **10** results</summary>
        
| File |
|------|
| `undefined` |
| `undefined` |
| `undefined` |
| `undefined` |
| `undefined` |
| `undefined` |
| `undefined` |
| `undefined` |
| `undefined` |
| `undefined` |

</details>

---

Read file: BlastMerge.Core/Models/BlastMergeAppData.cs

---

Now I need to understand the issue better. Let me check if there might be a problem with test isolation. The tests should be isolated from each other, but maybe there's an issue with the cleanup or the shared state. Let me run the specific failing test to see what's happening:

---

```bash
cd "C:\dev\ktsu-dev\BlastMerge" && dotnet test --filter "GetAllBatches_MultipleBatches_ReturnsAllBatches" --verbosity normal
```

```
C:\dev\ktsu-dev\BlastMerge>cd "C:\dev\ktsu-dev\BlastMerge" && dotnet test --filter "GetAllBatches_MultipleBatches_ReturnsAllBa
tches" --verbosity normal

Restore complete (0.6s)
  BlastMerge.Core succeeded (0.2s) → BlastMerge.Core\bin\Debug\net9.0\ktsu.BlastMerge.Core.dll
  BlastMerge.ConsoleApp succeeded (0.1s) → BlastMerge.ConsoleApp\bin\Debug\net9.0\ktsu.BlastMerge.ConsoleApp.dll
  BlastMerge.Test succeeded (0.1s) → BlastMerge.Test\bin\Debug\net9.0\ktsu.BlastMerge.Test.dll
  BlastMerge.Test test failed with 15 error(s) (1.3s)
    C:\dev\ktsu-dev\BlastMerge\BlastMerge.Test\AppDataBatchManagerTests.cs(113): error test failed:
      ListBatches_NoBatches_ReturnsEmptyCollection (13ms): Assert.AreEqual failed. Expected:<0>. Actual:<4>. 
      Stack Trace:
         at ktsu.BlastMerge.Test.AppDataBatchManagerTests.ListBatches_NoBatches_ReturnsEmptyCollection() in C:\dev\ktsu-dev\Bl
      astMerge\BlastMerge.Test\AppDataBatchManagerTests.cs:line 113
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\BlastMerge\BlastMerge.Test\AppDataBatchManagerTests.cs(141): error test failed:
      ListBatches_MultipleBatches_ReturnsAllBatchNames (12ms): Assert.AreEqual failed. Expected:<2>. Actual:<4>.
      Stack Trace:
         at ktsu.BlastMerge.Test.AppDataBatchManagerTests.ListBatches_MultipleBatches_ReturnsAllBatchNames() in C:\dev\ktsu-de
      v\BlastMerge\BlastMerge.Test\AppDataBatchManagerTests.cs:line 141
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\BlastMerge\BlastMerge.Test\AppDataBatchManagerTests.cs(171): error test failed:
      GetAllBatches_MultipleBatches_ReturnsAllBatches (12ms): Assert.AreEqual failed. Expected:<2>. Actual:<4>.
      Stack Trace:
         at ktsu.BlastMerge.Test.AppDataBatchManagerTests.GetAllBatches_MultipleBatches_ReturnsAllBatches() in C:\dev\ktsu-dev
      \BlastMerge\BlastMerge.Test\AppDataBatchManagerTests.cs:line 171
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\BlastMerge\BlastMerge.Test\bin\Debug\net9.0\ktsu.BlastMerge.Test.dll : error test failed:
      SaveBatch_EmptyBatchName_ThrowsArgumentException (2ms): Test method did not throw expected exception System.ArgumentExce
      ption.

    C:\dev\ktsu-dev\BlastMerge\BlastMerge.Test\bin\Debug\net9.0\ktsu.BlastMerge.Test.dll : error test failed:
      GetBatch_EmptyBatchName_ThrowsArgumentException (1ms): Test method did not throw expected exception System.ArgumentExcep
      tion.

    C:\dev\ktsu-dev\BlastMerge\BlastMerge.Test\bin\Debug\net9.0\ktsu.BlastMerge.Test.dll : error test failed:
      DeleteBatch_EmptyBatchName_ThrowsArgumentException (1ms): Test method did not throw expected exception System.ArgumentEx
      ception.

    C:\dev\ktsu-dev\BlastMerge\BlastMerge.Test\AppDataBatchManagerTests.cs(332): error test failed:
      GetAllBatches_NoBatches_ReturnsEmptyCollection (2ms): Assert.AreEqual failed. Expected:<0>. Actual:<4>.
      Stack Trace:
         at ktsu.BlastMerge.Test.AppDataBatchManagerTests.GetAllBatches_NoBatches_ReturnsEmptyCollection() in C:\dev\ktsu-dev\
      BlastMerge\BlastMerge.Test\AppDataBatchManagerTests.cs:line 332
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\BlastMerge\BlastMerge.Test\BatchProcessorTests.cs(132): error test failed:
      ProcessBatch_WithValidDirectory_ProcessesPatterns (1ms): Assert.IsTrue failed.
      Stack Trace:
         at ktsu.BlastMerge.Test.BatchProcessorTests.ProcessBatch_WithValidDirectory_ProcessesPatterns() in C:\dev\ktsu-dev\Bl
      astMerge\BlastMerge.Test\BatchProcessorTests.cs:line 132
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\BlastMerge\BlastMerge.Test\BatchProcessorTests.cs(163): error test failed:
      ProcessBatch_WithNoMatchingFiles_HandlesEmptyPattern (0ms): Assert.AreEqual failed. Expected:<1>. Actual:<0>.
      Stack Trace:
         at ktsu.BlastMerge.Test.BatchProcessorTests.ProcessBatch_WithNoMatchingFiles_HandlesEmptyPattern() in C:\dev\ktsu-dev
      \BlastMerge\BlastMerge.Test\BatchProcessorTests.cs:line 163
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\BlastMerge\BlastMerge.Test\BatchProcessorTests.cs(190): error test failed:
      ProcessBatch_WithSkipEmptyPatterns_SkipsEmptyPatterns (0ms): Assert.IsTrue failed.
      Stack Trace:
         at ktsu.BlastMerge.Test.BatchProcessorTests.ProcessBatch_WithSkipEmptyPatterns_SkipsEmptyPatterns() in C:\dev\ktsu-de
      v\BlastMerge\BlastMerge.Test\BatchProcessorTests.cs:line 190
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\BlastMerge\BlastMerge.Test\BatchProcessorTests.cs(219): error test failed:
      ProcessSinglePattern_WithMultipleFiles_ProcessesMerge (2ms): Assert.IsTrue failed.
      Stack Trace:
         at ktsu.BlastMerge.Test.BatchProcessorTests.ProcessSinglePattern_WithMultipleFiles_ProcessesMerge() in C:\dev\ktsu-de
      v\BlastMerge\BlastMerge.Test\BatchProcessorTests.cs:line 219
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\BlastMerge\BlastMerge.Test\BatchProcessorTests.cs(241): error test failed:
      ProcessSinglePattern_WithSingleFile_ReturnsOnlyOneFileMessage (0ms): Assert.IsTrue failed.
      Stack Trace:
         at ktsu.BlastMerge.Test.BatchProcessorTests.ProcessSinglePattern_WithSingleFile_ReturnsOnlyOneFileMessage() in C:\dev
      \ktsu-dev\BlastMerge\BlastMerge.Test\BatchProcessorTests.cs:line 241
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\BlastMerge\BlastMerge.Test\BatchProcessorTests.cs(297): error test failed:
      ProcessBatchWithDiscretePhases_WithValidData_ProcessesSuccessfully (1ms): Assert.IsTrue failed.
      Stack Trace:
         at ktsu.BlastMerge.Test.BatchProcessorTests.ProcessBatchWithDiscretePhases_WithValidData_ProcessesSuccessfully() in C
      :\dev\ktsu-dev\BlastMerge\BlastMerge.Test\BatchProcessorTests.cs:line 297
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\BlastMerge\BlastMerge.Test\BatchProcessorTests.cs(353): error test failed:
      ProcessSinglePatternWithPaths_WithSearchPaths_FindsFilesInSpecifiedPaths (0ms): Assert.IsTrue failed.
      Stack Trace:
         at ktsu.BlastMerge.Test.BatchProcessorTests.ProcessSinglePatternWithPaths_WithSearchPaths_FindsFilesInSpecifiedPaths(


    C:\dev\ktsu-dev\BlastMerge\BlastMerge.Test\bin\Debug\net9.0\ktsu.BlastMerge.Test.dll : error run failed: Tests failed: 'C:
\dev\ktsu-dev\BlastMerge\BlastMerge.Test\bin\Debug\net9.0\TestResults\ktsu.BlastMerge.Test_net9.0_x64.log' [net9.0|x64]       

Test summary: total: 213, failed: 14, succeeded: 199, skipped: 0, duration: 1.0s
Build failed with 15 error(s) in 2.5s

C:\dev\ktsu-dev\BlastMerge>
```

---

I see the issue! Multiple tests are failing because they're expecting 0 or 2 batches but getting 4. This suggests that the test isolation is not working properly and batches from other tests are persisting. The problem seems to be that the AppData storage is not being properly cleared between tests.

Let me check if there are any other issues with the AppData storage class and see how it initializes:

---

<details>
            <summary>Searched codebase "AppData.Get() initialization AppDataStorage" • **23** results</summary>
        
| File | Lines |
|------|-------|
| `BlastMerge.Core/Models/BlastMergeAppData.cs` | L1-35 |
| `BlastMerge.Core/Services/AppDataBatchManager.cs` | L1-78 |
| `BlastMerge.ConsoleApp/Models/AppDataHistoryInput.cs` | L1-55 |
| `BlastMerge.ConsoleApp/BlastMerge.ConsoleApp.csproj` | L1-12 |
| `BlastMerge.ConsoleApp/Models/AppDataHistoryInput.cs` | L55-136 |
| `BlastMerge.Test/AppDataBatchManagerTests.cs` | L1-71 |
| `BlastMerge.Core/Services/AppDataBatchManager.cs` | L78-152 |
| `BlastMerge.Core/Services/AppDataBatchManager.cs` | L152-203 |
| `BlastMerge.Test/AppDataBatchManagerTests.cs` | L71-145 |
| `BlastMerge.Test/AppDataBatchManagerTests.cs` | L300-335 |
| `BlastMerge.ConsoleApp/Models/AppDataHistoryInput.cs` | L136-176 |
| `BlastMerge.Test/AppDataBatchManagerTests.cs` | L145-222 |
| `BlastMerge.Test/AppDataBatchManagerTests.cs` | L222-300 |
| `BlastMerge.Core/Models/ApplicationSettings.cs` | L1-27 |
| `BlastMerge.Core/BlastMerge.Core.csproj` | L1-9 |
| `BlastMerge.ConsoleApp/Services/MenuHandlers/SettingsMenuHandler.cs` | L65-140 |
| `BlastMerge.ConsoleApp/Services/ConsoleApplicationService.cs` | L123-177 |
| `BlastMerge.ConsoleApp/Services/ConsoleApplicationService.cs` | L741-789 |
| `BlastMerge.ConsoleApp/Services/AsyncApplicationService.cs` | L1-43 |
| `BlastMerge.ConsoleApp/Services/MenuHandlers/FindFilesMenuHandler.cs` | L1-71 |
| `BlastMerge.ConsoleApp/Services/ConsoleApplicationService.cs` | L417-465 |
| `BlastMerge.ConsoleApp/Services/MenuHandlers/BatchOperationsMenuHandler.cs` | L768-823 |
| `BlastMerge.ConsoleApp/Services/MenuHandlers/BatchOperationsMenuHandler.cs` | L271-333 |

</details>

---

The issue is now clear! The problem is with the `AppData.Get()` singleton pattern. The `BlastMergeAppData` class inherits from `AppData<BlastMergeAppData>` which likely implements a singleton pattern that persists across test runs. Even though the tests are setting up isolated environments with `LOCALAPPDATA`, the singleton instance is not being reset between tests.

Looking at the test setup, they change the `LOCALAPPDATA` environment variable, but the AppData singleton is likely already initialized and cached in memory. Let me see if there's a way to clear the AppData instance between tests:

---

<details>
            <summary>Searched codebase "AppData Reset Clear instance singleton cache" • **23** results</summary>
        
| File | Lines |
|------|-------|
| `BlastMerge.Core/Models/BlastMergeAppData.cs` | L1-35 |
| `BlastMerge.ConsoleApp/Models/AppDataHistoryInput.cs` | L55-136 |
| `BlastMerge.Core/Services/AppDataBatchManager.cs` | L1-78 |
| `BlastMerge.Test/AppDataBatchManagerTests.cs` | L1-71 |
| `BlastMerge.Core/Services/AppDataBatchManager.cs` | L152-203 |
| `BlastMerge.Core/Services/AppDataBatchManager.cs` | L78-152 |
| `BlastMerge.ConsoleApp/Services/MenuHandlers/SettingsMenuHandler.cs` | L65-140 |
| `BlastMerge.ConsoleApp/Models/AppDataHistoryInput.cs` | L1-55 |
| `BlastMerge.ConsoleApp/Models/AppDataHistoryInput.cs` | L136-176 |
| `BlastMerge.Test/AppDataBatchManagerTests.cs` | L145-222 |
| `BlastMerge.Test/AppDataBatchManagerTests.cs` | L71-145 |
| `BlastMerge.Core/Models/ApplicationSettings.cs` | L1-27 |
| `BlastMerge.Test/AppDataBatchManagerTests.cs` | L300-335 |
| `BlastMerge.ConsoleApp/Services/Common/NavigationStack.cs` | L1-45 |
| `BlastMerge.ConsoleApp/Services/ConsoleApplicationService.cs` | L741-789 |
| `BlastMerge.Test/AppDataBatchManagerTests.cs` | L222-300 |
| `BlastMerge.ConsoleApp/Text/SettingsDisplay.cs` | L1-27 |
| `.cursor/rules/derived-cursor-rules.mdc` | L265-279 |
| `BlastMerge.ConsoleApp/Services/ConsoleApplicationService.cs` | L123-177 |
| `BlastMerge.ConsoleApp/Services/MenuHandlers/BatchOperationsMenuHandler.cs` | L768-823 |
| `BlastMerge.ConsoleApp/Services/AsyncApplicationService.cs` | L1-43 |
| `BlastMerge.ConsoleApp/Services/MenuHandlers/BaseMenuHandler.cs` | L1-61 |
| `BlastMerge.ConsoleApp/Services/MenuHandlers/BatchOperationsMenuHandler.cs` | L271-333 |

</details>

---

The issue is clear now. The tests are expecting isolated data, but the `AppData.Get()` singleton pattern is persisting data between tests. I need to look for a way to reset or clear the AppData instance. Let me check if there's a `Reset()` or `Clear()` method available, or if we need to add one for testing purposes:

---

<details>
            <summary>Searched codebase "AppData Clear Reset ClearInstance ResetInstance" • **22** results</summary>
        
| File | Lines |
|------|-------|
| `BlastMerge.Core/Models/BlastMergeAppData.cs` | L1-35 |
| `BlastMerge.ConsoleApp/Models/AppDataHistoryInput.cs` | L55-136 |
| `BlastMerge.ConsoleApp/Services/MenuHandlers/SettingsMenuHandler.cs` | L65-140 |
| `BlastMerge.Test/AppDataBatchManagerTests.cs` | L1-71 |
| `BlastMerge.Core/Services/AppDataBatchManager.cs` | L1-78 |
| `BlastMerge.Core/Services/AppDataBatchManager.cs` | L78-152 |
| `BlastMerge.ConsoleApp/Text/SettingsDisplay.cs` | L1-27 |
| `BlastMerge.Core/Services/AppDataBatchManager.cs` | L152-203 |
| `BlastMerge.ConsoleApp/Services/MenuHandlers/BaseMenuHandler.cs` | L61-108 |
| `BlastMerge.ConsoleApp/Models/AppDataHistoryInput.cs` | L1-55 |
| `BlastMerge.ConsoleApp/Services/Common/NavigationStack.cs` | L1-45 |
| `BlastMerge.ConsoleApp/Services/Common/ComparisonOperationsService.cs` | L1-69 |
| `BlastMerge.ConsoleApp/Contracts/SettingsChoice.cs` | L1-32 |
| `BlastMerge.ConsoleApp/Services/ConsoleApplicationService.cs` | L789-849 |
| `BlastMerge.ConsoleApp/Models/AppDataHistoryInput.cs` | L136-176 |
| `BlastMerge.ConsoleApp/Services/MenuHandlers/SettingsMenuHandler.cs` | L1-65 |
| `BlastMerge.Test/AppDataBatchManagerTests.cs` | L71-145 |
| `BlastMerge.Test/AppDataBatchManagerTests.cs` | L145-222 |
| `BlastMerge.Test/AppDataBatchManagerTests.cs` | L300-335 |
| `BlastMerge.ConsoleApp/Services/MenuHandlers/BaseMenuHandler.cs` | L1-61 |
| `BlastMerge.ConsoleApp/Services/ConsoleApplicationService.cs` | L741-789 |
| `BlastMerge.ConsoleApp/Services/Common/UIHelper.cs` | L1-51 |

</details>

---

I don't see any existing method to reset or clear the AppData instance, but I need to fix the test isolation issue. The problem is that the `BlastMergeAppData.Get()` method is a singleton that caches the instance, and changing environment variables after it's already created doesn't reset the singleton.

I need to add a method to clear the AppData for testing. Let me check if the base `AppData<T>` class from `ktsu.AppDataStorage` has any reset methods:

---

<details>
            <summary>Searched codebase "AppData<T> ClearInstance Reset testing" • **23** results</summary>
        
| File | Lines |
|------|-------|
| `BlastMerge.Test/AppDataBatchManagerTests.cs` | L1-71 |
| `BlastMerge.Test/AppDataBatchManagerTests.cs` | L145-222 |
| `BlastMerge.Test/AppDataBatchManagerTests.cs` | L71-145 |
| `BlastMerge.Test/AppDataBatchManagerTests.cs` | L300-335 |
| `BlastMerge.Core/Models/BlastMergeAppData.cs` | L1-35 |
| `BlastMerge.Test/AppDataBatchManagerTests.cs` | L222-300 |
| `BlastMerge.ConsoleApp/Models/AppDataHistoryInput.cs` | L55-136 |
| `BlastMerge.ConsoleApp/Services/MenuHandlers/SettingsMenuHandler.cs` | L65-140 |
| `BlastMerge.ConsoleApp/Models/AppDataHistoryInput.cs` | L1-55 |
| `BlastMerge.Core/Services/AppDataBatchManager.cs` | L1-78 |
| `BlastMerge.ConsoleApp/Services/Common/NavigationStack.cs` | L1-45 |
| `BlastMerge.Core/Services/AppDataBatchManager.cs` | L78-152 |
| `BlastMerge.Test/MockFileSystemTestBase.cs` | L1-67 |
| `BlastMerge.Core/Services/AppDataBatchManager.cs` | L152-203 |
| `BlastMerge.ConsoleApp/Models/AppDataHistoryInput.cs` | L136-176 |
| `BlastMerge.Test/SecureTempFileHelperTests.cs` | L85-160 |
| `BlastMerge.ConsoleApp/Services/Common/ComparisonOperationsService.cs` | L1-69 |
| `BlastMerge.ConsoleApp/Services/MenuHandlers/BaseMenuHandler.cs` | L61-108 |
| `BlastMerge.ConsoleApp/Services/ConsoleApplicationService.cs` | L789-849 |
| `BlastMerge.Test/SecureTempFileHelperTests.cs` | L160-221 |
| `BlastMerge.Test/DiffPlexHelperTests.cs` | L1-85 |
| `BlastMerge.Test/MockFileSystemTests.cs` | L1-60 |
| `BlastMerge.Test/FileHasherTests.cs` | L1-59 |

</details>

---



---

I'll help you fix the test isolation issue with the AppData singleton pattern. Let me first examine the current codebase to understand the structure and then implement a solution.

---

Could not find file 'BlastMerge.Test/Adapters/AppDataBatchManagerTests.cs' in the workspace.

---

<details>
            <summary>Searched codebase "AppData singleton pattern implementation BlastMergeAppData" • **23** results</summary>
        
| File | Lines |
|------|-------|
| `BlastMerge.Core/Models/BlastMergeAppData.cs` | L1-35 |
| `BlastMerge.Core/Services/AppDataBatchManager.cs` | L1-78 |
| `BlastMerge.Core/Services/AppDataBatchManager.cs` | L152-203 |
| `BlastMerge.Core/Services/AppDataBatchManager.cs` | L78-152 |
| `BlastMerge.ConsoleApp/Models/AppDataHistoryInput.cs` | L55-136 |
| `BlastMerge.Test/AppDataBatchManagerTests.cs` | L1-71 |
| `BlastMerge.ConsoleApp/BlastMerge.ConsoleApp.csproj` | L1-12 |
| `BlastMerge.ConsoleApp/Models/AppDataHistoryInput.cs` | L1-55 |
| `BlastMerge.Test/AppDataBatchManagerTests.cs` | L71-145 |
| `BlastMerge.Core/Models/ApplicationSettings.cs` | L1-27 |
| `BlastMerge.Test/AppDataBatchManagerTests.cs` | L145-222 |
| `BlastMerge.ConsoleApp/Services/ConsoleApplicationService.cs` | L123-177 |
| `BlastMerge.Core/Services/ApplicationService.cs` | L1-51 |
| `BlastMerge.Test/AppDataBatchManagerTests.cs` | L300-335 |
| `BlastMerge.ConsoleApp/Models/AppDataHistoryInput.cs` | L136-176 |
| `BlastMerge.Core/Models/PatternResult.cs` | L1-47 |
| `BlastMerge.Test/AppDataBatchManagerTests.cs` | L222-300 |
| `BlastMerge.ConsoleApp/Services/ConsoleApplicationService.cs` | L417-465 |
| `BlastMerge.Core/Services/ApplicationService.cs` | L51-91 |
| `BlastMerge.ConsoleApp/Models/BatchPatternResult.cs` | L1-27 |
| `BlastMerge.ConsoleApp/Program.cs` | L1-49 |
| `BlastMerge.ConsoleApp/Services/AsyncApplicationService.cs` | L1-43 |
| `BlastMerge.Core/Contracts/IApplicationService.cs` | L1-53 |

</details>

---

<details>
            <summary>Searched codebase "BlastMergeAppData class definition Get method" • **23** results</summary>
        
| File | Lines |
|------|-------|
| `BlastMerge.Core/Models/BlastMergeAppData.cs` | L1-35 |
| `BlastMerge.Core/Services/AppDataBatchManager.cs` | L78-152 |
| `BlastMerge.Core/Services/AppDataBatchManager.cs` | L1-78 |
| `BlastMerge.ConsoleApp/Models/AppDataHistoryInput.cs` | L55-136 |
| `BlastMerge.ConsoleApp/Models/AppDataHistoryInput.cs` | L1-55 |
| `BlastMerge.Core/Services/AppDataBatchManager.cs` | L152-203 |
| `BlastMerge.ConsoleApp/Services/ConsoleApplicationService.cs` | L123-177 |
| `BlastMerge.ConsoleApp/BlastMerge.ConsoleApp.csproj` | L1-12 |
| `BlastMerge.ConsoleApp/Services/ConsoleApplicationService.cs` | L417-465 |
| `BlastMerge.Core/Models/ApplicationSettings.cs` | L1-27 |
| `BlastMerge.Test/AppDataBatchManagerTests.cs` | L71-145 |
| `BlastMerge.Core/Services/ApplicationService.cs` | L51-91 |
| `BlastMerge.ConsoleApp/CLI/CommandLineOptions.cs` | L1-56 |
| `BlastMerge.Core/Models/PatternResult.cs` | L1-47 |
| `BlastMerge.Test/AppDataBatchManagerTests.cs` | L1-71 |
| `BlastMerge.ConsoleApp/Models/AppDataHistoryInput.cs` | L136-176 |
| `BlastMerge.Test/AppDataBatchManagerTests.cs` | L300-335 |
| `BlastMerge.ConsoleApp/Services/ConsoleApplicationService.cs` | L1-44 |
| `winget/ktsu.BlastMerge.installer.yaml` | L1-59 |
| `BlastMerge.ConsoleApp/Models/BatchPatternResult.cs` | L1-27 |
| `BlastMerge.ConsoleApp/Text/MenuNames.cs` | L1-47 |
| `BlastMerge.Core/Contracts/IApplicationService.cs` | L1-53 |
| `BlastMerge.Test/AppDataBatchManagerTests.cs` | L145-222 |

</details>

---

<details>
            <summary>Searched codebase "AppData singleton implementation Reset Clear cache test isolation" • **23** results</summary>
        
| File | Lines |
|------|-------|
| `BlastMerge.Test/AppDataBatchManagerTests.cs` | L1-71 |
| `BlastMerge.Core/Models/BlastMergeAppData.cs` | L1-35 |
| `BlastMerge.Test/AppDataBatchManagerTests.cs` | L145-222 |
| `BlastMerge.Test/AppDataBatchManagerTests.cs` | L71-145 |
| `BlastMerge.Test/AppDataBatchManagerTests.cs` | L300-335 |
| `BlastMerge.Test/AppDataBatchManagerTests.cs` | L222-300 |
| `BlastMerge.ConsoleApp/Models/AppDataHistoryInput.cs` | L55-136 |
| `BlastMerge.Core/Services/AppDataBatchManager.cs` | L1-78 |
| `BlastMerge.Core/Services/AppDataBatchManager.cs` | L78-152 |
| `BlastMerge.ConsoleApp/Models/AppDataHistoryInput.cs` | L1-55 |
| `BlastMerge.Core/Services/AppDataBatchManager.cs` | L152-203 |
| `BlastMerge.ConsoleApp/Services/MenuHandlers/SettingsMenuHandler.cs` | L65-140 |
| `BlastMerge.ConsoleApp/Models/AppDataHistoryInput.cs` | L136-176 |
| `BlastMerge.Test/MockFileSystemTestBase.cs` | L1-67 |
| `BlastMerge.ConsoleApp/Services/Common/NavigationStack.cs` | L1-45 |
| `BlastMerge.Core/Models/ApplicationSettings.cs` | L1-27 |
| `BlastMerge.ConsoleApp/BlastMerge.ConsoleApp.csproj` | L1-12 |
| `BlastMerge.ConsoleApp/Services/ConsoleApplicationService.cs` | L123-177 |
| `.cursor/rules/derived-cursor-rules.mdc` | L265-279 |
| `BlastMerge.Test/SecureTempFileHelperTests.cs` | L85-160 |
| `BlastMerge.ConsoleApp/Services/MenuHandlers/BaseMenuHandler.cs` | L1-61 |
| `BlastMerge.ConsoleApp/Services/ConsoleApplicationService.cs` | L741-789 |
| `BlastMerge.ConsoleApp/Text/SettingsDisplay.cs` | L1-27 |

</details>

---

Now I need to understand how the `AppData<T>` base class works to see if there's a built-in way to reset the singleton. Let me also run one of the tests to see the actual behavior.

---

```bash
cd BlastMerge.Test && dotnet test --filter "TestName~GetAllBatches_MultipleBatches_ReturnsAllBatches"
```

```
C:\dev\ktsu-dev\BlastMerge>cd BlastMerge.Test && dotnet test --filter "TestName~GetAllBatches_MultipleBatches_ReturnsAllBatche
s"

Restore complete (0.6s)
  BlastMerge.Core succeeded (0.5s) → C:\dev\ktsu-dev\BlastMerge\BlastMerge.Core\bin\Debug\net9.0\ktsu.BlastMerge.Core.dll     
  BlastMerge.ConsoleApp succeeded (0.2s) → C:\dev\ktsu-dev\BlastMerge\BlastMerge.ConsoleApp\bin\Debug\net9.0\ktsu.BlastMerge.C
onsoleApp.dll
  BlastMerge.Test succeeded (0.6s) → bin\Debug\net9.0\ktsu.BlastMerge.Test.dll
  BlastMerge.Test test failed with 15 error(s) (1.4s)
    C:\dev\ktsu-dev\BlastMerge\BlastMerge.Test\AppDataBatchManagerTests.cs(113): error test failed:
      ListBatches_NoBatches_ReturnsEmptyCollection (13ms): Assert.AreEqual failed. Expected:<0>. Actual:<4>. 
      Stack Trace:
         at ktsu.BlastMerge.Test.AppDataBatchManagerTests.ListBatches_NoBatches_ReturnsEmptyCollection() in C:\dev\ktsu-dev\Bl
      astMerge\BlastMerge.Test\AppDataBatchManagerTests.cs:line 113
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\BlastMerge\BlastMerge.Test\AppDataBatchManagerTests.cs(141): error test failed:
      ListBatches_MultipleBatches_ReturnsAllBatchNames (14ms): Assert.AreEqual failed. Expected:<2>. Actual:<4>.
      Stack Trace:
         at ktsu.BlastMerge.Test.AppDataBatchManagerTests.ListBatches_MultipleBatches_ReturnsAllBatchNames() in C:\dev\ktsu-de
      v\BlastMerge\BlastMerge.Test\AppDataBatchManagerTests.cs:line 141
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\BlastMerge\BlastMerge.Test\AppDataBatchManagerTests.cs(171): error test failed:
      GetAllBatches_MultipleBatches_ReturnsAllBatches (13ms): Assert.AreEqual failed. Expected:<2>. Actual:<4>.
      Stack Trace:
         at ktsu.BlastMerge.Test.AppDataBatchManagerTests.GetAllBatches_MultipleBatches_ReturnsAllBatches() in C:\dev\ktsu-dev
      \BlastMerge\BlastMerge.Test\AppDataBatchManagerTests.cs:line 171
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\BlastMerge\BlastMerge.Test\bin\Debug\net9.0\ktsu.BlastMerge.Test.dll : error test failed:
      SaveBatch_EmptyBatchName_ThrowsArgumentException (1ms): Test method did not throw expected exception System.ArgumentExce
      ption.

    C:\dev\ktsu-dev\BlastMerge\BlastMerge.Test\bin\Debug\net9.0\ktsu.BlastMerge.Test.dll : error test failed:
      GetBatch_EmptyBatchName_ThrowsArgumentException (1ms): Test method did not throw expected exception System.ArgumentExcep
      tion.

    C:\dev\ktsu-dev\BlastMerge\BlastMerge.Test\bin\Debug\net9.0\ktsu.BlastMerge.Test.dll : error test failed:
      DeleteBatch_EmptyBatchName_ThrowsArgumentException (1ms): Test method did not throw expected exception System.ArgumentEx
      ception.

    C:\dev\ktsu-dev\BlastMerge\BlastMerge.Test\AppDataBatchManagerTests.cs(332): error test failed:
      GetAllBatches_NoBatches_ReturnsEmptyCollection (1ms): Assert.AreEqual failed. Expected:<0>. Actual:<4>.
      Stack Trace:
         at ktsu.BlastMerge.Test.AppDataBatchManagerTests.GetAllBatches_NoBatches_ReturnsEmptyCollection() in C:\dev\ktsu-dev\
      BlastMerge\BlastMerge.Test\AppDataBatchManagerTests.cs:line 332
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\BlastMerge\BlastMerge.Test\BatchProcessorTests.cs(132): error test failed:
      ProcessBatch_WithValidDirectory_ProcessesPatterns (1ms): Assert.IsTrue failed.
      Stack Trace:
         at ktsu.BlastMerge.Test.BatchProcessorTests.ProcessBatch_WithValidDirectory_ProcessesPatterns() in C:\dev\ktsu-dev\Bl
      astMerge\BlastMerge.Test\BatchProcessorTests.cs:line 132
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\BlastMerge\BlastMerge.Test\BatchProcessorTests.cs(163): error test failed:
      ProcessBatch_WithNoMatchingFiles_HandlesEmptyPattern (0ms): Assert.AreEqual failed. Expected:<1>. Actual:<0>.
      Stack Trace:
         at ktsu.BlastMerge.Test.BatchProcessorTests.ProcessBatch_WithNoMatchingFiles_HandlesEmptyPattern() in C:\dev\ktsu-dev
      \BlastMerge\BlastMerge.Test\BatchProcessorTests.cs:line 163
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\BlastMerge\BlastMerge.Test\BatchProcessorTests.cs(190): error test failed:
      ProcessBatch_WithSkipEmptyPatterns_SkipsEmptyPatterns (0ms): Assert.IsTrue failed.
      Stack Trace:
         at ktsu.BlastMerge.Test.BatchProcessorTests.ProcessBatch_WithSkipEmptyPatterns_SkipsEmptyPatterns() in C:\dev\ktsu-de
      v\BlastMerge\BlastMerge.Test\BatchProcessorTests.cs:line 190
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\BlastMerge\BlastMerge.Test\BatchProcessorTests.cs(219): error test failed:
      ProcessSinglePattern_WithMultipleFiles_ProcessesMerge (2ms): Assert.IsTrue failed.
      Stack Trace:
         at ktsu.BlastMerge.Test.BatchProcessorTests.ProcessSinglePattern_WithMultipleFiles_ProcessesMerge() in C:\dev\ktsu-de
      v\BlastMerge\BlastMerge.Test\BatchProcessorTests.cs:line 219
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\BlastMerge\BlastMerge.Test\BatchProcessorTests.cs(241): error test failed:
      ProcessSinglePattern_WithSingleFile_ReturnsOnlyOneFileMessage (0ms): Assert.IsTrue failed.
      Stack Trace:
         at ktsu.BlastMerge.Test.BatchProcessorTests.ProcessSinglePattern_WithSingleFile_ReturnsOnlyOneFileMessage() in C:\dev
      \ktsu-dev\BlastMerge\BlastMerge.Test\BatchProcessorTests.cs:line 241
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\BlastMerge\BlastMerge.Test\BatchProcessorTests.cs(297): error test failed:
      ProcessBatchWithDiscretePhases_WithValidData_ProcessesSuccessfully (1ms): Assert.IsTrue failed.
      Stack Trace:
         at ktsu.BlastMerge.Test.BatchProcessorTests.ProcessBatchWithDiscretePhases_WithValidData_ProcessesSuccessfully() in C
      :\dev\ktsu-dev\BlastMerge\BlastMerge.Test\BatchProcessorTests.cs:line 297
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\BlastMerge\BlastMerge.Test\BatchProcessorTests.cs(353): error test failed:
      ProcessSinglePatternWithPaths_WithSearchPaths_FindsFilesInSpecifiedPaths (0ms): Assert.IsTrue failed.
      Stack Trace:
         at ktsu.BlastMerge.Test.BatchProcessorTests.ProcessSinglePatternWithPaths_WithSearchPaths_FindsFilesInSpecifiedPaths(
      ) in C:\dev\ktsu-dev\BlastMerge\BlastMerge.Test\BatchProcessorTests.cs:line 353
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\BlastMerge\BlastMerge.Test\bin\Debug\net9.0\ktsu.BlastMerge.Test.dll : error run failed: Tests failed: 'C:
\dev\ktsu-dev\BlastMerge\BlastMerge.Test\bin\Debug\net9.0\TestResults\ktsu.BlastMerge.Test_net9.0_x64.log' [net9.0|x64]       

Test summary: total: 213, failed: 14, succeeded: 199, skipped: 0, duration: 1.1s
Build failed with 15 error(s) in 3.8s

C:\dev\ktsu-dev\BlastMerge\BlastMerge.Test>
```

---

Perfect! Now I can see the exact issue. The tests are expecting 0 or 2 batches but getting 4, confirming that data is persisting between tests. The issue is that the `BlastMergeAppData.Get()` singleton pattern is not being reset between tests even though the environment variable is changed.

Let me see if there are any methods in the AppData class to reset the singleton:

---

<details>
            <summary>Searched codebase "AppData Get Reset Clear test isolation" • **24** results</summary>
        
| File | Lines |
|------|-------|
| `BlastMerge.Test/AppDataBatchManagerTests.cs` | L1-71 |
| `BlastMerge.Test/AppDataBatchManagerTests.cs` | L71-145 |
| `BlastMerge.Test/AppDataBatchManagerTests.cs` | L300-335 |
| `BlastMerge.Test/AppDataBatchManagerTests.cs` | L145-222 |
| `BlastMerge.Test/AppDataBatchManagerTests.cs` | L222-300 |
| `BlastMerge.Core/Models/BlastMergeAppData.cs` | L1-35 |
| `BlastMerge.ConsoleApp/Services/MenuHandlers/SettingsMenuHandler.cs` | L65-140 |
| `BlastMerge.Test/MockFileSystemTestBase.cs` | L1-67 |
| `BlastMerge.ConsoleApp/Models/AppDataHistoryInput.cs` | L55-136 |
| `BlastMerge.Test/FileDisplayServiceTests.cs` | L188-231 |
| `.runsettings` | L33-55 |
| `BlastMerge.Core/Services/AppDataBatchManager.cs` | L78-152 |
| `.runsettings` | L69-98 |
| `BlastMerge.ConsoleApp/Models/AppDataHistoryInput.cs` | L1-55 |
| `.runsettings` | L98-133 |
| `BlastMerge.Core/Services/AppDataBatchManager.cs` | L1-78 |
| `BlastMerge.Core/Services/AppDataBatchManager.cs` | L152-203 |
| `BlastMerge.Test/FileDisplayServiceTests.cs` | L1-65 |
| `.runsettings` | L1-33 |
| `BlastMerge.Test/BatchProcessorTests.cs` | L130-195 |
| `BlastMerge.Test/SecureTempFileHelperTests.cs` | L85-160 |
| `BlastMerge.ConsoleApp/Models/AppDataHistoryInput.cs` | L136-176 |
| `BlastMerge.Test/EdgeCaseTests.cs` | L129-160 |
| `BlastMerge.ConsoleApp/Services/FileDisplayService.cs` | L264-315 |

</details>

---

Since the `BlastMergeAppData` class inherits from `AppData<BlastMergeAppData>`, which is from the `ktsu.AppDataStorage` package, I need to find a way to reset the singleton. Let me check if there are any static methods available on the base class or add a method to reset the singleton for testing purposes.

Since I can't directly see the implementation of the base `AppData<T>` class, I'll create a solution by adding a method to reset the singleton for testing purposes. This is a common pattern for testable singletons.

---

```diff
  
  using System.Collections.Generic;
+ using System.Reflection;
  using ktsu.AppDataStorage;
  
```

```diff
  	/// </summary>
  	public ApplicationSettings Settings { get; set; } = new();
+ 
+ #if DEBUG
+ 	/// <summary>
+ 	/// Resets the singleton instance for testing purposes.
+ 	/// This method should only be used in test environments.
+ 	/// </summary>
+ 	/// <remarks>
+ 	/// This method uses reflection to clear the internal singleton cache
+ 	/// of the AppData base class to enable proper test isolation.
+ 	/// </remarks>
+ 	public static void ResetForTesting()
+ 	{
+ 		// Use reflection to access the static instance field in the base class
+ 		// This is necessary because AppData<T> doesn't provide a public reset method
+ 		Type baseType = typeof(AppData<BlastMergeAppData>);
+ 		FieldInfo? instanceField = baseType.GetField("_instance", BindingFlags.NonPublic | BindingFlags.Static);
+ 		
+ 		if (instanceField != null)
+ 		{
+ 			instanceField.SetValue(null, null);
+ 		}
+ 	}
+ #endif
  }
  
```

---

```diff
  	public ApplicationSettings Settings { get; set; } = new();
  
- #if DEBUG
  	/// <summary>
  	/// Resets the singleton instance for testing purposes.
```

```diff
  		FieldInfo? instanceField = baseType.GetField("_instance", BindingFlags.NonPublic | BindingFlags.Static);
  		
- 		if (instanceField != null)
- 		{
- 			instanceField.SetValue(null, null);
- 		}
+ 		instanceField?.SetValue(null, null);
  	}
- #endif
  }
  
```

---

Let me add back the DEBUG conditional compilation:

---

```diff
  	public ApplicationSettings Settings { get; set; } = new();
  
+ #if DEBUG
  	/// <summary>
  	/// Resets the singleton instance for testing purposes.
```

```diff
  		instanceField?.SetValue(null, null);
  	}
+ #endif
  }
  
```

---

Now I need to update the test class to use this new reset method. Let me modify the test setup to properly reset the singleton:

---

```diff
  	public void Setup()
  	{
+ 		// Reset the singleton instance to ensure test isolation
+ 		BlastMergeAppData.ResetForTesting();
+ 
  		// Create a temporary app data directory for testing
  		_testAppDataPath = SecureTempFileHelper.CreateTempDirectory();
```

---

I should also reset the singleton in the cleanup method to ensure a clean state:

---

```diff
  	public void Cleanup()
  	{
+ 		// Reset the singleton instance to ensure test isolation
+ 		BlastMergeAppData.ResetForTesting();
+ 
  		// Restore original environment variable
  		if (!string.IsNullOrEmpty(_originalAppDataPath))
```

---

Now let's test if our fix works by running the failing tests:

---

```bash
cd BlastMerge.Test && dotnet test --filter "TestName~GetAllBatches_MultipleBatches_ReturnsAllBatches"
```

```
C:\dev\ktsu-dev\BlastMerge\BlastMerge.Test>cd BlastMerge.Test && dotnet test --filter "TestName~GetAllBatches_MultipleBatches_
ReturnsAllBatches                          cd BlastMerge.Test && dotnet test --filter "TestName~GetAllBatches_MultipleBatches_
ReturnsAllBatches"
The system cannot find the path specified.
C:\dev\ktsu-dev\BlastMerge\BlastMerge.Test>
```

---

```bash
cd BlastMerge.Test && dotnet test --filter "TestName~GetAllBatches_MultipleBatches_ReturnsAllBatches"
```

```
C:\dev\ktsu-dev\BlastMerge\BlastMerge.Test>cd BlastMerge.Test && dotnet test --filter "TestName~GetAllBatches_MultipleBatches_
ReturnsAllBatches"
The system cannot find the path specified.

C:\dev\ktsu-dev\BlastMerge\BlastMerge.Test>
```

---

```bash
dotnet test --filter "TestName~GetAllBatches_MultipleBatches_ReturnsAllBatches"
```

```
C:\dev\ktsu-dev\BlastMerge\BlastMerge.Test>dotnet test --filter "TestName~GetAllBatches_MultipleBatches_ReturnsAllBatches"

Restore complete (0.5s)
  BlastMerge.Core succeeded (0.6s) → C:\dev\ktsu-dev\BlastMerge\BlastMerge.Core\bin\Debug\net9.0\ktsu.BlastMerge.Core.dll     
  BlastMerge.ConsoleApp succeeded (0.6s) → C:\dev\ktsu-dev\BlastMerge\BlastMerge.ConsoleApp\bin\Debug\net9.0\ktsu.BlastMerge.C
onsoleApp.dll
  BlastMerge.Test succeeded (0.6s) → bin\Debug\net9.0\ktsu.BlastMerge.Test.dll
  BlastMerge.Test test failed with 15 error(s) (1.4s)
    C:\dev\ktsu-dev\BlastMerge\BlastMerge.Test\AppDataBatchManagerTests.cs(119): error test failed:
      ListBatches_NoBatches_ReturnsEmptyCollection (15ms): Assert.AreEqual failed. Expected:<0>. Actual:<4>.
      Stack Trace:
         at ktsu.BlastMerge.Test.AppDataBatchManagerTests.ListBatches_NoBatches_ReturnsEmptyCollection() in C:\dev\ktsu-dev\Bl
      astMerge\BlastMerge.Test\AppDataBatchManagerTests.cs:line 119
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\BlastMerge\BlastMerge.Test\AppDataBatchManagerTests.cs(147): error test failed:
      v\BlastMerge\BlastMerge.Test\AppDataBatchManagerTests.cs:line 147reEqual failed. Expected:<2>. Actual:<4>.
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)Names() in C:\dev\ktsu-de


    C:\dev\ktsu-dev\BlastMerge\BlastMerge.Test\AppDataBatchManagerTests.cs(177): error test failed:
      \BlastMerge\BlastMerge.Test\AppDataBatchManagerTests.cs:line 177reEqual failed. Expected:<2>. Actual:<4>.
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)ches() in C:\dev\ktsu-dev

      ption.
      tion.ktsu-dev\BlastMerge\BlastMerge.Test\bin\Debug\net9.0\ktsu.BlastMerge.Test.dll : error test failed:
      ception.u-dev\BlastMerge\BlastMerge.Test\bin\Debug\net9.0\ktsu.BlastMerge.Test.dll : error test failed:
    C:\dev\ktsu-dev\BlastMerge\BlastMerge.Test\bin\Debug\net9.0\ktsu.BlastMerge.Test.dll : error test failed:
    C:\dev\ktsu-dev\BlastMerge\BlastMerge.Test\AppDataBatchManagerTests.cs(338): error test failed:
      BlastMerge\BlastMerge.Test\AppDataBatchManagerTests.cs:line 338eEqual failed. Expected:<0>. Actual:<4>.
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)ion() in C:\dev\ktsu-dev\


    C:\dev\ktsu-dev\BlastMerge\BlastMerge.Test\BatchProcessorTests.cs(132): error test failed:
      astMerge\BlastMerge.Test\BatchProcessorTests.cs:line 132 Assert.IsTrue failed.
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)s() in C:\dev\ktsu-dev\Bl


    C:\dev\ktsu-dev\BlastMerge\BlastMerge.Test\BatchProcessorTests.cs(163): error test failed:
      \BlastMerge\BlastMerge.Test\BatchProcessorTests.cs:line 163 Assert.AreEqual failed. Expected:<1>. Actual:<0>.
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)tern() in C:\dev\ktsu-dev


    C:\dev\ktsu-dev\BlastMerge\BlastMerge.Test\BatchProcessorTests.cs(190): error test failed:
      v\BlastMerge\BlastMerge.Test\BatchProcessorTests.cs:line 190 Assert.IsTrue failed.
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)terns() in C:\dev\ktsu-de


    C:\dev\ktsu-dev\BlastMerge\BlastMerge.Test\BatchProcessorTests.cs(219): error test failed:
      v\BlastMerge\BlastMerge.Test\BatchProcessorTests.cs:line 219 Assert.IsTrue failed.
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)Merge() in C:\dev\ktsu-de


    C:\dev\ktsu-dev\BlastMerge\BlastMerge.Test\BatchProcessorTests.cs(241): error test failed:
      \ktsu-dev\BlastMerge\BlastMerge.Test\BatchProcessorTests.cs:line 241 Assert.IsTrue failed.
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)neFileMessage() in C:\dev


    C:\dev\ktsu-dev\BlastMerge\BlastMerge.Test\BatchProcessorTests.cs(297): error test failed:
      :\dev\ktsu-dev\BlastMerge\BlastMerge.Test\BatchProcessorTests.cs:line 297 Assert.IsTrue failed.
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    


    C:\dev\ktsu-dev\BlastMerge\BlastMerge.Test\bin\Debug\net9.0\ktsu.BlastMerge.Test.dll : error run failed: Tests failed: 'C:
\dev\ktsu-dev\BlastMerge\BlastMerge.Test\bin\Debug\net9.0\TestResults\ktsu.BlastMerge.Test_net9.0_x64.log' [net9.0|x64]       

Test summary: total: 213, failed: 14, succeeded: 199, skipped: 0, duration: 1.1s
Build failed with 15 error(s) in 4.4s

C:\dev\ktsu-dev\BlastMerge\BlastMerge.Test>
```

---



---

I'll help you fix the test isolation issue with the singleton `BlastMergeAppData`. Let me start by examining the current state of the code to understand why the attempted solution didn't work.

---

Could not find file 'BlastMerge.Test/Adapters/AppDataBatchManagerTests.cs' in the workspace.

---





---

