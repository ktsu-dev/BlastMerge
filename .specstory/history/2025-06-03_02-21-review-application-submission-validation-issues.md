<!-- Generated by SpecStory -->

# Review application submission validation issues (2025-06-03 12:21:11)

_**User**_

im trying to get this a[pplication submitted to winget, however it is failing validation by their moderators. can you please take a look and see what the issue might be? I suspect it might be to do with the input history and getting the lcoation of the app data directory during their tests. here is the PR:

@https://github.com/microsoft/winget-pkgs/pull/262069 

---

_**Assistant**_



---

Looking at the winget PR, I can see there are several validation failures occurring. The main issues appear to be:

1. **Directory Not Found Errors**: `COR_E_DIRECTORYNOTFOUND` - "ALLUSERSPROFILE Microsoft network dir doesn't exist"
2. **CLR Assertion Failure**: Related to shadow stacks when running `--version`

Let me examine your BlastMerge application to understand what might be causing these issues.

---

<details>
            <summary>Searched codebase "app data directory input history location" • **13** results</summary>
        
| File | Lines |
|------|-------|
| `BlastMerge.ConsoleApp/HistoryInput.cs` | L1-62 |
| `BlastMerge.ConsoleApp/HistoryInput.cs` | L275-337 |
| `BlastMerge.ConsoleApp/HistoryInput.cs` | L62-112 |
| `BlastMerge.ConsoleApp/HistoryInput.cs` | L178-242 |
| `BlastMerge.ConsoleApp/Program.cs` | L514-573 |
| `BlastMerge.ConsoleApp/HistoryInput.cs` | L242-275 |
| `BlastMerge.ConsoleApp/HistoryInput.cs` | L112-178 |
| `BlastMerge.ConsoleApp/Program.cs` | L459-514 |
| `BlastMerge.ConsoleApp/Program.cs` | L148-215 |
| `BlastMerge.ConsoleApp/Program.cs` | L1-76 |
| `BlastMerge.ConsoleApp/Program.cs` | L573-625 |
| `BlastMerge.ConsoleApp/Program.cs` | L76-148 |
| `BlastMerge.ConsoleApp/Program.cs` | L215-275 |

</details>

---

Now let me look at the main Program.cs file to understand how the application starts and handles the `--version` command:

---

Read file: Program.cs

---

This appears to be a test Program.cs file, not the main console application. Let me check the actual console application:

---

Read file: BlastMerge.ConsoleApp/Program.cs

---

I can see the issue now! The application doesn't handle the `--version` command-line argument that winget is trying to test. Let me check if there's any version handling in the project files:

---

<details>
            <summary>Grep search for "--version" • **0** files</summary>
        
No results found
</details>

---

<details>
            <summary>Grep search for "Version" • **0** files</summary>
        
No results found
</details>

---

Read file: VERSION.md

---

Read file: Directory.Packages.props

---

Now I've identified the main issues causing the winget validation failures:

## Problems Identified:

1. **Missing `--version` Command Support**: The application doesn't handle the `--version` argument that winget validation requires. When winget calls `blastmerge.exe --version`, it fails because the application doesn't recognize this command.

2. **History File Directory Access Issue**: The `HistoryInput.cs` file tries to create a directory in `ApplicationData` during static initialization, which may fail in the winget validation sandbox environment.

3. **CLR Shadow Stack Issue**: The second error shows a CLR assertion failure related to shadow stacks, which might be related to the .NET 9 runtime or specific security configurations in the validation environment.

## Solutions:

Let me implement fixes for these issues:

---

```diff
  
  		Console.OutputEncoding = System.Text.Encoding.UTF8;
+ 
+ 		// Handle version command for winget validation
+ 		if (args.Length > 0 && (args[0] == "--version" || args[0] == "-v" || args[0] == "/version"))
+ 		{
+ 			ShowVersion();
+ 			return;
+ 		}
+ 
+ 		// Handle help command
+ 		if (args.Length > 0 && (args[0] == "--help" || args[0] == "-h" || args[0] == "/?" || args[0] == "/help"))
+ 		{
+ 			ShowCommandLineHelp();
+ 			return;
+ 		}
  
  		try
```

```diff
  		};
  	}
+ 
+ 	/// <summary>
+ 	/// Shows the application version
+ 	/// </summary>
+ 	private static void ShowVersion()
+ 	{
+ 		try
+ 		{
+ 			// Try to read version from VERSION.md file
+ 			var versionFile = Path.Combine(AppContext.BaseDirectory, "VERSION.md");
+ 			if (File.Exists(versionFile))
+ 			{
+ 				var version = File.ReadAllText(versionFile).Trim();
+ 				Console.WriteLine(version);
+ 				return;
+ 			}
+ 
+ 			// Fallback to assembly version
+ 			var assembly = System.Reflection.Assembly.GetExecutingAssembly();
+ 			var version2 = assembly.GetName().Version?.ToString() ?? "1.0.0";
+ 			Console.WriteLine(version2);
+ 		}
+ 		catch
+ 		{
+ 			// Fallback version if everything fails
+ 			Console.WriteLine("1.0.14");
+ 		}
+ 	}
+ 
+ 	/// <summary>
+ 	/// Shows command line help
+ 	/// </summary>
+ 	private static void ShowCommandLineHelp()
+ 	{
+ 		Console.WriteLine("BlastMerge - Cross-Repository File Synchronization");
+ 		Console.WriteLine();
+ 		Console.WriteLine("Usage:");
+ 		Console.WriteLine("  BlastMerge.exe                           Start interactive mode");
+ 		Console.WriteLine("  BlastMerge.exe <directory> <filename>    Process files directly");
+ 		Console.WriteLine("  BlastMerge.exe --version                 Show version");
+ 		Console.WriteLine("  BlastMerge.exe --help                    Show this help");
+ 		Console.WriteLine();
+ 		Console.WriteLine("Examples:");
+ 		Console.WriteLine("  BlastMerge.exe C:\\Projects README.md");
+ 		Console.WriteLine("  BlastMerge.exe --version");
+ 	}
  }
  
```

---

Now let me fix the potential issue with the HistoryInput class accessing ApplicationData directory during static initialization:

---

```diff
  public static class HistoryInput
  {
- 	private static readonly string HistoryFile = Path.Combine(
- 		Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData),
- 		"BlastMerge",
- 		"input_history.json");
+ 	private static readonly string HistoryFile = GetHistoryFilePath();
  
  	private static Dictionary<string, List<string>> inputHistory = [];
```

```diff
  
  	static HistoryInput() => LoadHistory();
+ 
+ 	/// <summary>
+ 	/// Gets the history file path, with fallback to temp directory if ApplicationData is not accessible
+ 	/// </summary>
+ 	/// <returns>Path to history file</returns>
+ 	private static string GetHistoryFilePath()
+ 	{
+ 		try
+ 		{
+ 			var appDataPath = Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData);
+ 			if (!string.IsNullOrEmpty(appDataPath))
+ 			{
+ 				return Path.Combine(appDataPath, "BlastMerge", "input_history.json");
+ 			}
+ 		}
+ 		catch
+ 		{
+ 			// Fall through to temp directory
+ 		}
+ 
+ 		try
+ 		{
+ 			var tempPath = Path.GetTempPath();
+ 			return Path.Combine(tempPath, "BlastMerge", "input_history.json");
+ 		}
+ 		catch
+ 		{
+ 			// Final fallback - use current directory
+ 			return Path.Combine(".", "blastmerge_history.json");
+ 		}
+ 	}
  
  	/// <summary>
```

---

Now let me also improve the error handling in the LoadHistory and SaveHistory methods to be more resilient:

---

Read file: BlastMerge.ConsoleApp/HistoryInput.cs

---

Let me improve the error handling further by making the SaveHistory method more robust:

---

```diff
  		try
  		{
- 			if (File.Exists(HistoryFile))
+ 			if (!string.IsNullOrEmpty(HistoryFile) && File.Exists(HistoryFile))
  			{
  				var json = File.ReadAllText(HistoryFile);
+ 				if (!string.IsNullOrWhiteSpace(json))
+ 				{
  					inputHistory = JsonSerializer.Deserialize<Dictionary<string, List<string>>>(json) ?? [];
+ 				}
  			}
  		}
```

```diff
  			inputHistory = [];
  		}
+ 		catch (DirectoryNotFoundException)
+ 		{
+ 			// If directory doesn't exist, start with empty history
+ 			inputHistory = [];
+ 		}
+ 		catch (Exception)
+ 		{
+ 			// Catch any other exceptions to ensure the app doesn't crash
+ 			inputHistory = [];
+ 		}
  	}
  
```

```diff
  		try
  		{
+ 			if (string.IsNullOrEmpty(HistoryFile))
+ 			{
+ 				return; // Can't save if we don't have a valid path
+ 			}
+ 
  			var directory = Path.GetDirectoryName(HistoryFile);
  			if (!string.IsNullOrEmpty(directory) && !Directory.Exists(directory))
```

```diff
  		catch (IOException)
  		{
- 			// Ignore file I/O failures
+ 			// Ignore file I/O failures - history is not critical
  		}
  		catch (UnauthorizedAccessException)
  		{
- 			// Ignore access denied failures
+ 			// Ignore access denied failures - history is not critical
  		}
  		catch (JsonException)
  		{
- 			// Ignore JSON serialization failures
+ 			// Ignore JSON serialization failures - history is not critical
+ 		}
+ 		catch (DirectoryNotFoundException)
+ 		{
+ 			// Ignore directory not found - history is not critical
+ 		}
+ 		catch (Exception)
+ 		{
+ 			// Catch any other exceptions to ensure the app doesn't crash
  		}
  	}
```

---

Now let me check if there are any project settings that might need adjustment for the CLR shadow stack issue. Let me look at the project files:

---

Read file: BlastMerge.ConsoleApp/BlastMerge.ConsoleApp.csproj

---

Read file: global.json

---

I notice this is using .NET 9 which might be causing compatibility issues with the winget validation environment. Let me check if there are any specific settings we should add to the project file. Let me also check if we can add a test to ensure the --version command works:

---

```bash
cd BlastMerge.ConsoleApp && dotnet build
```

```
 PS C:\dev\ktsu-dev\BlastMerge >
  02:25:21   BlastMerge  
  12:25:21 main  ?3 ~3 
 PS C:\dev\ktsu-dev\BlastMerge >cd BlastMerge.ConsoleApp && dotnet build
```

---

```bash
cd BlastMerge.ConsoleApp && dotnet run -- --version
```

```

Restore complete (1.0s)
  BlastMerge.Core                                                      CoreCompile (1.5s) 
                                                                                   (1.5s)


  BlastMerge.Core                                                      CoreCompile (1.6s) 

                                                                                   (1.6s) 

  BlastMerge.Core succeeded (5.3s) → C:\dev\ktsu-dev\BlastMerge\BlastMerge.Core\bin\Debug\
net9.0\ktsu.BlastMerge.Core.dll
  BlastMerge.ConsoleApp failed with 7 error(s) (0.5s)
    C:\dev\ktsu-dev\BlastMerge\BlastMerge.ConsoleApp\HistoryInput.cs(335,10): error CS0160
: A previous catch clause already catches all exceptions of this or of a super type ('IOEx
ception')
    C:\dev\ktsu-dev\BlastMerge\BlastMerge.ConsoleApp\HistoryInput.cs(380,10): error CS0160
: A previous catch clause already catches all exceptions of this or of a super type ('IOEx
ception')
    C:\dev\ktsu-dev\BlastMerge\BlastMerge.ConsoleApp\HistoryInput.cs(384,3): error CA1031:
 Modify 'SaveHistory' to catch a more specific allowed exception type, or rethrow the exce
ption (https://learn.microsoft.com/dotnet/fundamentals/code-analysis/quality-rules/ca1031)
    C:\dev\ktsu-dev\BlastMerge\BlastMerge.ConsoleApp\HistoryInput.cs(340,3): error CA1031:
 Modify 'LoadHistory' to catch a more specific allowed exception type, or rethrow the exce
ption (https://learn.microsoft.com/dotnet/fundamentals/code-analysis/quality-rules/ca1031)
    C:\dev\ktsu-dev\BlastMerge\BlastMerge.ConsoleApp\HistoryInput.cs(40,3): error CA1031: 
Modify 'GetHistoryFilePath' to catch a more specific allowed exception type, or rethrow th
e exception (https://learn.microsoft.com/dotnet/fundamentals/code-analysis/quality-rules/c
    C:\dev\ktsu-dev\BlastMerge\BlastMerge.ConsoleApp\HistoryInput.cs(50,3): error CA1031:
Modify 'GetHistoryFilePath' to catch a more specific allowed exception type, or rethrow th
e exception (https://learn.microsoft.com/dotnet/fundamentals/code-analysis/quality-rules/c
a1031)
    C:\dev\ktsu-dev\BlastMerge\BlastMerge.ConsoleApp\Program.cs(1236,3): error CA1031: Mod
ify 'ShowVersion' to catch a more specific allowed exception type, or rethrow the exceptio
n (https://learn.microsoft.com/dotnet/fundamentals/code-analysis/quality-rules/ca1031)

Build failed with 7 error(s) in 7.7s
  02:25:30   BlastMerge  8.049s   1 - ERROR 
  12:25:30 main  ?3 ~3 
 PS C:\dev\ktsu-dev\BlastMerge\BlastMerge.ConsoleApp >cd BlastMerge.ConsoleApp && dotnet r
un -- --version

```

---

I need to fix the compilation errors. The issues are with exception handling - some catch clauses are unreachable and the analyzer is complaining about catching generic exceptions:

---

```diff
  			}
  		}
- 		catch
+ 		catch (System.Security.SecurityException)
+ 		{
+ 			// Fall through to temp directory
+ 		}
+ 		catch (PlatformNotSupportedException)
  		{
  			// Fall through to temp directory  
```

```diff
  			return Path.Combine(tempPath, "BlastMerge", "input_history.json");
  		}
- 		catch
+ 		catch (System.Security.SecurityException)
+ 		{
+ 			// Final fallback - use current directory
+ 		}
+ 		catch (PlatformNotSupportedException)
  		{
  			// Final fallback - use current directory
- 			return Path.Combine(".", "blastmerge_history.json");
  		}
+ 
+ 		return Path.Combine(".", "blastmerge_history.json");
  	}
  
```

---

```diff
  			inputHistory = [];
  		}
- 		catch (DirectoryNotFoundException)
+ 		catch (System.Security.SecurityException)
  		{
- 			// If directory doesn't exist, start with empty history
+ 			// If security exception, start with empty history
  			inputHistory = [];
  		}
- 		catch (Exception)
- 		{
- 			// Catch any other exceptions to ensure the app doesn't crash
- 			inputHistory = [];
- 		}
+ 
+ 		// Ensure inputHistory is never null
+ 		inputHistory ??= [];
  	}
  
```

---

```diff
  			// Ignore JSON serialization failures - history is not critical
  		}
- 		catch (DirectoryNotFoundException)
+ 		catch (System.Security.SecurityException)
  		{
- 			// Ignore directory not found - history is not critical
- 		}
- 		catch (Exception)
- 		{
- 			// Catch any other exceptions to ensure the app doesn't crash
+ 			// Ignore security exceptions - history is not critical
  		}
  	}
```

---

```diff
  			Console.WriteLine(version2);
  		}
- 		catch
+ 		catch (IOException)
  		{
- 			// Fallback version if everything fails
+ 			// Fallback version if file reading fails
+ 			Console.WriteLine("1.0.14");
+ 		}
+ 		catch (UnauthorizedAccessException)
+ 		{
+ 			// Fallback version if access denied
+ 			Console.WriteLine("1.0.14");
+ 		}
+ 		catch (System.Security.SecurityException)
+ 		{
+ 			// Fallback version if security exception
  			Console.WriteLine("1.0.14");
  		}
```

---

Now let's test the build again:

---

```bash
dotnet build
```

```
 PS C:\dev\ktsu-dev\BlastMerge\BlastMerge.ConsoleApp >dotnet build

  C:\dev\ktsu-dev\BlastMerge\BlastMerge.ConsoleApp\BlastMerge.ConsoleApp.csproj    (0.0s) 
Restore complete (0.5s)
  BlastMerge.Core succeeded (0.1s) → C:\dev\ktsu-dev\BlastMerge\BlastMerge.Core\bin\Debug\
net9.0\ktsu.BlastMerge.Core.dll
  BlastMerge.ConsoleApp succeeded (0.7s) → bin\Debug\net9.0\ktsu.BlastMerge.ConsoleApp.dll

Build succeeded in 2.0s
  02:26:19   BlastMerge  2.259s  
  12:26:19 main  ?3 ~3 
 PS C:\dev\ktsu-dev\BlastMerge\BlastMerge.ConsoleApp >
```

---

Great! Now let's test the version command:

---

```bash
dotnet run -- --version
```

```
 PS C:\dev\ktsu-dev\BlastMerge\BlastMerge.ConsoleApp >dotnet run -- --version

  C:\dev\ktsu-dev\BlastMerge\BlastMerge.ConsoleApp\BlastMerge.ConsoleApp.csproj    (0.0s)
                                                                                   (0.1s) 
1.0.14.0
  02:26:25   BlastMerge  2.002s  
  12:26:25 main  ?3 ~3 
 PS C:\dev\ktsu-dev\BlastMerge\BlastMerge.ConsoleApp >
```

---

Excellent! The version command is working. Now let's also test the help command:

---

```bash
dotnet run -- --help
```

```
 PS C:\dev\ktsu-dev\BlastMerge\BlastMerge.ConsoleApp >dotnet run -- --help   

  C:\dev\ktsu-dev\BlastMerge\BlastMerge.ConsoleApp\BlastMerge.ConsoleApp.csproj    (0.0s) 
BlastMerge - Cross-Repository File Synchronization

Usage:
  BlastMerge.exe                           Start interactive mode
  BlastMerge.exe <directory> <filename>    Process files directly
  BlastMerge.exe --version                 Show version
  BlastMerge.exe --help                    Show this help

Examples:
  BlastMerge.exe C:\Projects README.md
  BlastMerge.exe --version
  02:26:30   BlastMerge  2.005s  
  12:26:30 main  ?3 ~3 
 PS C:\dev\ktsu-dev\BlastMerge\BlastMerge.ConsoleApp >
```

---

Perfect! Now let me create a simple test to verify the functionality works properly. However, first let me consider one more potential issue with the CLR shadow stack error. This might be related to .NET 9 compatibility. Let me check if we should target a more compatible framework version for winget distribution:

---

Read file: BlastMerge.Core/BlastMerge.Core.csproj

---

Let me check if we can find out what target framework these ktsu SDKs use. For now, let me also add a potential fix for the shadow stack issue by creating a configuration file that can help with runtime settings:

---

```diff
- 
+ {
+   "runtimeOptions": {
+     "configProperties": {
+       "System.Runtime.Serialization.EnableUnsafeBinaryFormatterSerialization": false,
+       "Microsoft.AspNetCore.SignalR.DisableImplicitFromServicesParameters": true
+     }
+   }
+ } 
```

---

Now let me build the entire solution and publish it to test:

---

```bash
cd .. && dotnet build
```

```
 PS C:\dev\ktsu-dev\BlastMerge\BlastMerge.ConsoleApp >cd .. && dotnet build

  C:\dev\ktsu-dev\BlastMerge\BlastMerge.sln                                Restore (0.0s) 
Restore complete (1.5s)
.dll
  BlastMerge.ConsoleApp succeeded (0.7s) → BlastMerge.ConsoleApp\bin\Debug\net9.0\ktsu.Bla
stMerge.ConsoleApp.dll
  BlastMerge.Test succeeded (1.3s) → BlastMerge.Test\bin\Debug\net9.0\ktsu.BlastMerge.Test
.dll

Build succeeded in 3.9s
  02:26:57   BlastMerge  4.214s  
  12:26:57 main  ?4 ~3 
 PS C:\dev\ktsu-dev\BlastMerge >
```

---

Great! Now let me create a simple integration test to make sure the version command works from the published executable:

---

```bash
cd BlastMerge.ConsoleApp && dotnet publish -c Release --self-contained false
```

```
 PS C:\dev\ktsu-dev\BlastMerge >cd BlastMerge.ConsoleApp && dotnet publish -c Release --se
  02:27:01   BlastMerge  
  12:27:01 main  ?4 ~3 
 PS C:\dev\ktsu-dev\BlastMerge >cd BlastMerge.ConsoleApp && dotnet publish -c Release --se
  02:27:02   BlastMerge  
  12:27:02 main  ?4 ~3 
 PS C:\dev\ktsu-dev\BlastMerge >cd BlastMerge.ConsoleApp && dotnet publish -c Release --se
lf-contained false
```

---





---

_**User**_

can we please use the CommandLineParser library for cli handling?

---

_**Assistant**_



---

Yes, absolutely! I can see the CommandLineParser library is already available in the packages. Let me refactor the CLI handling to use it properly.

---

Read file: BlastMerge.ConsoleApp/BlastMerge.ConsoleApp.csproj

---

Let me check what CommandLineParser version is available and add it to the project:

---

```bash
cd BlastMerge.ConsoleApp && dotnet add package CommandLineParser
```

```
Report.yaml
Thank you!

### Environment
PSReadLine: 2.3.6+d2e770f93b7a53d8660a6402eb29d1ae1c35e767
PowerShell: 7.5.1
OS: Microsoft Windows 10.0.26100
BufferWidth: 90
BufferHeight: 1

Last 200 Keys:

 n Spacebar - - Spacebar - - v e r s i o n Enter
 d o t n e t Spacebar r u n Spacebar - - Spacebar - - h e l p Enter
 c d Spacebar . . Spacebar & & Spacebar d o t n e t Spacebar b u i l d Enter
 c d Spacebar B l a s t M e r g e . C o n s o l e A p p Spacebar & & Spacebar d o t n e t 
Spacebar p u b l i s h Spacebar - c Spacebar R e l e a s e Spacebar - - s e l f - c o n t 
a i n e d Spacebar f a l s e Enter
 c d Spacebar B l a s t M e r g e . C o n s o l e A p p Spacebar & & Spacebar d o t n e t 
Spacebar a d d Spacebar p a c k a g e Spacebar C o m m a n d L i n e P a r s e r Enter



### Exception

System.ArgumentOutOfRangeException: The value must be greater than or equal to zero and le
ss than the console's buffer size in that dimension. (Parameter 'top')
Actual value was 13.
   at System.ConsolePal.SetCursorPosition(Int32 left, Int32 top)
   at Microsoft.PowerShell.PSConsoleReadLine.ReallyRender(RenderData renderData, String de
faultColor)
   at Microsoft.PowerShell.PSConsoleReadLine.ForceRender()
   at Microsoft.PowerShell.PSConsoleReadLine.Render()
   at Microsoft.PowerShell.PSConsoleReadLine.ProcessOneKey(PSKeyInfo key, Dictionary`2 dis
patchTable, Boolean ignoreIfNoAction, Object arg)
   at Microsoft.PowerShell.PSConsoleReadLine.InputLoop()
   at Microsoft.PowerShell.PSConsoleReadLine.ReadLine(Runspace runspace, EngineIntrinsics 
engineIntrinsics, CancellationToken cancellationToken, Nullable`1 lastRunStatus)


  02:27:20   BlastMerge   1 - ERROR 
  12:27:20 main  ?4 ~3 
 PS C:\dev\ktsu-dev\BlastMerge\BlastMerge.ConsoleApp >rser












```

---

The command seems to have completed successfully despite the error output. Let me check if the package was added and then create the command line options class:

---

Read file: BlastMerge.ConsoleApp/BlastMerge.ConsoleApp.csproj

---

It seems the package wasn't added. Let me try to add it manually to the csproj file:

---

```diff
    <ItemGroup>
      <PackageReference Include="Spectre.Console" />
+     <PackageReference Include="CommandLineParser" Version="2.9.1" />
    </ItemGroup>
  
```

---

Now let me create a command line options class and update the Program.cs file to use CommandLineParser:

---

```diff
- 
+ // Copyright (c) ktsu.dev
+ // All rights reserved.
+ // Licensed under the MIT license.
+ 
+ namespace ktsu.BlastMerge.ConsoleApp;
+ 
+ using CommandLine;
+ 
+ /// <summary>
+ /// Command line options for BlastMerge console application
+ /// </summary>
+ public class CommandLineOptions
+ {
+ 	/// <summary>
+ 	/// Show version information
+ 	/// </summary>
+ 	[Option('v', "version", HelpText = "Show version information")]
+ 	public bool ShowVersion { get; set; }
+ 
+ 	/// <summary>
+ 	/// Show help information
+ 	/// </summary>
+ 	[Option('h', "help", HelpText = "Show help information")]
+ 	public bool ShowHelp { get; set; }
+ 
+ 	/// <summary>
+ 	/// Directory path to search for files
+ 	/// </summary>
+ 	[Value(0, MetaName = "directory", HelpText = "Directory path to search for files", Required = false)]
+ 	public string? Directory { get; set; }
+ 
+ 	/// <summary>
+ 	/// Filename to search for in the directory
+ 	/// </summary>
+ 	[Value(1, MetaName = "filename", HelpText = "Filename to search for in the directory", Required = false)]
+ 	public string? FileName { get; set; }
+ } 
```

---

Now let me update the Program.cs file to use CommandLineParser:

---

```diff
  using Spectre.Console;
  using DiffPlex.DiffBuilder.Model;
+ using CommandLine;
  
  /// <summary>
- /// Main program class for the DiffMore TUI
+ /// Main program class for the BlastMerge TUI
  /// </summary>
  public static class Program
```

```diff
  		Console.OutputEncoding = System.Text.Encoding.UTF8;
  
+ 		// Parse command line arguments using CommandLineParser
+ 		var parser = new Parser(with => 
+ 		{
+ 			with.HelpWriter = null; // We'll handle help output ourselves
+ 			with.CaseSensitive = false;
+ 		});
+ 
+ 		var parseResult = parser.ParseArguments<CommandLineOptions>(args);
+ 
+ 		parseResult
+ 			.WithParsed<CommandLineOptions>(options =>
+ 			{
  				// Handle version command for winget validation
- 		if (args.Length > 0 && (args[0] == "--version" || args[0] == "-v" || args[0] == "/version"))
+ 				if (options.ShowVersion)
  				{
  					ShowVersion();
```

```diff
  
  				// Handle help command
- 		if (args.Length > 0 && (args[0] == "--help" || args[0] == "-h" || args[0] == "/?" || args[0] == "/help"))
+ 				if (options.ShowHelp)
  				{
  					ShowCommandLineHelp();
```

```diff
  					ShowBanner();
  
- 			// If args are provided, try to use them directly
- 			if (args.Length >= 2)
- 			{
- 				var directory = args[0];
- 				var fileName = args[1];
- 
- 				if (Directory.Exists(directory))
+ 					// If directory and filename are provided, try to use them directly
+ 					if (!string.IsNullOrEmpty(options.Directory) && !string.IsNullOrEmpty(options.FileName))
+ 					{
+ 						if (Directory.Exists(options.Directory))
  						{
- 					ProcessFiles(directory, fileName);
+ 							ProcessFiles(options.Directory, options.FileName);
+ 							return;
+ 						}
+ 						else
+ 						{
+ 							AnsiConsole.MarkupLine($"[red]Error: Directory '{options.Directory}' does not exist![/]");
  							return;
  						}
```

```diff
  					AnsiConsole.WriteException(ex);
  				}
+ 			})
+ 			.WithNotParsed(errors =>
+ 			{
+ 				// Check if it's just a help or version request that failed parsing
+ 				if (errors.Any(e => e.Tag == ErrorType.HelpRequestedError || e.Tag == ErrorType.VersionRequestedError))
+ 				{
+ 					ShowCommandLineHelp();
+ 					return;
+ 				}
+ 
+ 				// For other parsing errors, show help
+ 				AnsiConsole.MarkupLine("[red]Invalid command line arguments.[/]");
+ 				ShowCommandLineHelp();
+ 			});
  	}
  
```

---

Now let me update the help text to be more appropriate for the CommandLineParser library and improve the ShowCommandLineHelp method:

---

```diff
  		Console.WriteLine("BlastMerge - Cross-Repository File Synchronization");
  		Console.WriteLine();
- 		Console.WriteLine("Usage:");
+ 		
+ 		// Generate help text using CommandLineParser
+ 		var parser = new Parser(with => 
+ 		{
+ 			with.HelpWriter = Console.Out;
+ 			with.CaseSensitive = false;
+ 		});
+ 
+ 		// This will print the auto-generated help
+ 		_ = parser.ParseArguments<CommandLineOptions>(["--help"]);
+ 
+ 		Console.WriteLine();
+ 		Console.WriteLine("Examples:");
  		Console.WriteLine("  BlastMerge.exe                           Start interactive mode");
- 		Console.WriteLine("  BlastMerge.exe <directory> <filename>    Process files directly");
+ 		Console.WriteLine("  BlastMerge.exe C:\\Projects README.md      Process files directly");
  		Console.WriteLine("  BlastMerge.exe --version                 Show version");
  		Console.WriteLine("  BlastMerge.exe --help                    Show this help");
  		Console.WriteLine();
- 		Console.WriteLine("Examples:");
- 		Console.WriteLine("  BlastMerge.exe C:\\Projects README.md");
- 		Console.WriteLine("  BlastMerge.exe --version");
+ 		Console.WriteLine("Interactive Mode Features:");
+ 		Console.WriteLine("  🔀 Iterative Merge Multiple Versions (PRIMARY FEATURE)");
+ 		Console.WriteLine("  🔍 Compare Files in Directory");
+ 		Console.WriteLine("  📁 Compare Two Directories");
+ 		Console.WriteLine("  📄 Compare Two Specific Files");
  	}
  }
```

---

Let me also improve the CommandLineOptions class to have better help text and add some additional useful options:

---

```diff
  /// Command line options for BlastMerge console application
  /// </summary>
+ [Verb("blastmerge", HelpText = "Cross-Repository File Synchronization Tool")]
  public class CommandLineOptions
  {
  	/// <summary>
  	/// Show version information
  	/// </summary>
- 	[Option('v', "version", HelpText = "Show version information")]
+ 	[Option('v', "version", HelpText = "Display version information and exit")]
  	public bool ShowVersion { get; set; }
  
  	/// <summary>
  	/// Show help information  
  	/// </summary>
- 	[Option('h', "help", HelpText = "Show help information")]
+ 	[Option('h', "help", HelpText = "Display this help screen and exit")]
  	public bool ShowHelp { get; set; }
  
  	/// <summary>
  	/// Directory path to search for files
  	/// </summary>
- 	[Value(0, MetaName = "directory", HelpText = "Directory path to search for files", Required = false)]
+ 	[Value(0, MetaName = "directory", 
+ 		HelpText = "Directory path to search for files. If provided with filename, runs in batch mode", 
+ 		Required = false)]
  	public string? Directory { get; set; }
  
  	/// <summary>
  	/// Filename to search for in the directory
  	/// </summary>
- 	[Value(1, MetaName = "filename", HelpText = "Filename to search for in the directory", Required = false)]
+ 	[Value(1, MetaName = "filename", 
+ 		HelpText = "Filename to search for in the directory. Used with directory for batch mode", 
+ 		Required = false)]
  	public string? FileName { get; set; }
+ 
+ 	/// <summary>
+ 	/// Examples usage text
+ 	/// </summary>
+ 	[Usage(ApplicationAlias = "BlastMerge.exe")]
+ 	public static IEnumerable<Example> Examples
+ 	{
+ 		get
+ 		{
+ 			return new List<Example>() {
+ 				new("Start interactive mode", new CommandLineOptions { }),
+ 				new("Process files directly", new CommandLineOptions { Directory = "C:\\Projects", FileName = "README.md" }),
+ 				new("Show version", new CommandLineOptions { ShowVersion = true }),
+ 				new("Show help", new CommandLineOptions { ShowHelp = true })
+ 			};
+ 		}
+ 	}
  }
  
```

---

Now let me test the build to make sure everything works correctly:

---

```bash
dotnet build
```

```

  C:\dev\ktsu-dev\BlastMerge\BlastMerge.ConsoleApp\BlastMerge.ConsoleApp.csproj    (0.0s)
NU1008: Projects that use central package version management should not define the version
 on the PackageReference items but on the PackageVersion items: CommandLineParser.

Restore failed with 1 error(s) in 1.2s
  02:28:32   BlastMerge  1.48s   1 - ERROR 
  12:28:32 main  ?5 ~4 

```

---

I need to fix the package reference. The project uses central package management, so I need to check the Directory.Packages.props file and add the version there:

---

Read file: Directory.Packages.props

---

I can see CommandLineParser is already defined with version 1.8.0.7. I need to remove the version from the project file and use the newer version that supports the features I'm using:

---

```diff
    <ItemGroup>
      <PackageReference Include="Spectre.Console" />
-     <PackageReference Include="CommandLineParser" Version="2.9.1" />
+     <PackageReference Include="CommandLineParser" />
    </ItemGroup>
  
```

---

Now I need to update the Directory.Packages.props to use a newer version of CommandLineParser that supports the features I'm using:

---

```diff
      <PackageVersion Include="Microsoft.SourceLink.GitHub" Version="1.0.0" />
      <PackageVersion Include="Microsoft.SourceLink.AzureRepos.Git" Version="1.0.0" />
-     <PackageVersion Include="CommandLineParser" Version="1.8.0.7" />
+     <PackageVersion Include="CommandLineParser" Version="2.9.1" />
      <PackageVersion Include="Moq" Version="4.20.72" />
      <PackageVersion Include="Spectre.Console" Version="0.50.0" />
```

---

I also need to add the missing using statements to the CommandLineOptions file:

---

```diff
  namespace ktsu.BlastMerge.ConsoleApp;
  
+ using System.Collections.Generic;
  using CommandLine;
+ using CommandLine.Text;
  
  /// <summary>
```

---

Now let me test the build again:

---

```bash
dotnet build
```

```
 PS C:\dev\ktsu-dev\BlastMerge\BlastMerge.ConsoleApp >dotnet build

  C:\dev\ktsu-dev\BlastMerge\BlastMerge.ConsoleApp\BlastMerge.ConsoleApp.csproj    (0.0s)
                                                                                   (0.1s) 
Restore complete (1.0s)
  BlastMerge.Core succeeded (0.5s) → C:\dev\ktsu-dev\BlastMerge\BlastMerge.Core\bin\Debug\
    C:\dev\ktsu-dev\BlastMerge\BlastMerge.ConsoleApp\Program.cs(1291,16): error CA2000: Ca
ll System.IDisposable.Dispose on object created by 'new Parser(with =>' before all referen
ces to it are out of scope (https://learn.microsoft.com/dotnet/fundamentals/code-analysis/
quality-rules/ca2000)

Build failed with 4 error(s) in 2.5s
  02:29:06   BlastMerge  2.858s   1 - ERROR 
  12:29:06 main  ?5 ~5 
 PS C:\dev\ktsu-dev\BlastMerge\BlastMerge.ConsoleApp >
```

---

I need to fix the CA2000 error by properly disposing the Parser. Let me update the code:

---

```diff
  
  		// Parse command line arguments using CommandLineParser
- 		var parser = new Parser(with =>
+ 		using var parser = new Parser(with =>
  		{
  			with.HelpWriter = null; // We'll handle help output ourselves
```

---

I also need to fix the ShowCommandLineHelp method:

---

```diff
  		
  		// Generate help text using CommandLineParser
- 		var parser = new Parser(with =>
+ 		using var parser = new Parser(with => 
  		{
  			with.HelpWriter = Console.Out;
```

---

Now let me test the build again:

---

```bash
dotnet build
```

```
 PS C:\dev\ktsu-dev\BlastMerge\BlastMerge.ConsoleApp >dotnet build

  C:\dev\ktsu-dev\BlastMerge\BlastMerge.ConsoleApp\BlastMerge.ConsoleApp.csproj    (0.0s)
                                                                                   (0.1s) 
Restore complete (0.6s)
  BlastMerge.Core succeeded (0.2s) → C:\dev\ktsu-dev\BlastMerge\BlastMerge.Core\bin\Debug\
net9.0\ktsu.BlastMerge.Core.dll
  BlastMerge.ConsoleApp failed with 2 error(s) (0.5s)
    C:\dev\ktsu-dev\BlastMerge\BlastMerge.ConsoleApp\Program.cs(95,25): error IDE0078: Use
es/ide0078)
    C:\dev\ktsu-dev\BlastMerge\BlastMerge.ConsoleApp\CommandLineOptions.cs(53,11): error I
DE0028: Collection initialization can be simplified (https://learn.microsoft.com/dotnet/fu
ndamentals/code-analysis/style-rules/ide0028)

Build failed with 2 error(s) in 2.3s
  02:29:43   BlastMerge  2.552s   1 - ERROR 
  12:29:43 main  ?5 ~5 
 PS C:\dev\ktsu-dev\BlastMerge\BlastMerge.ConsoleApp >
```

---

I need to fix these analyzer warnings. Let me fix them:

---

```diff
  			{
  				// Check if it's just a help or version request that failed parsing
- 				if (errors.Any(e => e.Tag == ErrorType.HelpRequestedError || e.Tag == ErrorType.VersionRequestedError))
+ 				if (errors.Any(e => e.Tag is ErrorType.HelpRequestedError or ErrorType.VersionRequestedError))
  				{
  					ShowCommandLineHelp();
```

---

```diff
  		get
  		{
- 			return new List<Example>() {
+ 			return [
  				new("Start interactive mode", new CommandLineOptions { }),
  				new("Process files directly", new CommandLineOptions { Directory = "C:\\Projects", FileName = "README.md" }),
  				new("Show version", new CommandLineOptions { ShowVersion = true }),
  				new("Show help", new CommandLineOptions { ShowHelp = true })
- 			};
+ 			];
  		}
  	}
```

---

Now let me test the build again:

---

```bash
dotnet build
```

```
 PS C:\dev\ktsu-dev\BlastMerge\BlastMerge.ConsoleApp >dotnet build

  C:\dev\ktsu-dev\BlastMerge\BlastMerge.ConsoleApp\BlastMerge.ConsoleApp.csproj    (0.0s)
                                                                                   (0.1s) 
Restore complete (0.6s)
  BlastMerge.Core succeeded (0.2s) → C:\dev\ktsu-dev\BlastMerge\BlastMerge.Core\bin\Debug\
net9.0\ktsu.BlastMerge.Core.dll
  BlastMerge.ConsoleApp succeeded (0.6s) → bin\Debug\net9.0\ktsu.BlastMerge.ConsoleApp.dll

Build succeeded in 2.3s
  02:30:08   BlastMerge  2.614s  
  12:30:08 main  ?5 ~5 
 PS C:\dev\ktsu-dev\BlastMerge\BlastMerge.ConsoleApp >
```

---

Great! Now let me test the new command line interface:

---



---



---



---



---



---



---



---



---



---



---



---



---



---



---

