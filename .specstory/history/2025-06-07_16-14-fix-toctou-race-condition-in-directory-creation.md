<!-- Generated by SpecStory -->

# Fix TOCTOU race condition in directory creation (2025-06-08 02:14:29)

_**User**_

Fix this bug...

The `CreateTempDirectory` method contains a Time-of-Check-Time-of-Use (TOCTOU) race condition. The `if (!Directory.Exists(fullPath))` check before `Directory.CreateDirectory(fullPath)` is vulnerable to a race if multiple threads attempt to create the same directory simultaneously. This initial check is unnecessary because `Directory.CreateDirectory` is atomic and safely handles cases where the directory already exists without throwing an exception.


---

_**Assistant**_



---

You're absolutely right! The `CreateTempDirectory` method has a classic TOCTOU race condition. The check-then-create pattern is vulnerable when multiple threads might be creating directories simultaneously.

Let me fix this by removing the unnecessary `Directory.Exists` check and implementing a marker file approach to ensure uniqueness:

---



---

Perfect! I've fixed the TOCTOU race condition by:

1. **Removing the vulnerable check**: Eliminated the `if (!Directory.Exists(fullPath))` check that created the race condition.

2. **Using atomic marker file creation**: Instead of relying on directory existence checks, I use `FileMode.CreateNew` to atomically create a marker file. This operation will fail if the file already exists, giving us a reliable way to detect if another thread claimed the directory first.

3. **Immediate cleanup**: The marker file is deleted immediately after successful creation, so it doesn't leave any artifacts.

4. **Proper exception handling**: The code catches `IOException` specifically when the marker file already exists, indicating a collision, and continues to the next iteration.

This approach ensures that:
- Multiple threads can safely call `CreateTempDirectory()` simultaneously
- Only one thread will successfully claim each unique directory path
- The method maintains its contract of returning a truly unique directory
- No race conditions exist between the check and create operations

The fix follows the same atomic creation pattern used in the `CreateTempFile` method, making the API consistent across both temporary file and directory creation.

---

